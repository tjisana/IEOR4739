#!/usr/bin/python
import sys
import numpy as np
import statsmodels.api as sm
import random
import time


if len(sys.argv) != 3:  # the program name and the datafile
  # stop the program and print an error message
  sys.exit("usage: stats.py returns.csv results.csv")

returnsFILE = sys.argv[1]
resultsFILE = sys.argv[2]

def reg_m(y, x):
    ones = np.ones(len(x[0]))
    X = sm.add_constant(np.column_stack((x[0], ones)))
    for ele in x[1:]:
        X = sm.add_constant(np.column_stack((ele, X)))
    results = sm.OLS(y, X).fit()
    return results

def reg0_m(y, x):
    X = x[0]
    for ele in x[1:]:
        X = np.column_stack((ele, X))
    results = sm.OLS(y, X).fit()
    return results

try:
    fout = open(resultsFILE, 'r') # opens the Results file
    picked10_name = fout.readline().strip().split(',')[:-1]
    fout.close()    	
except IOError:
    print ("Cannot open file %s\n" % ResultsFile)
    sys.exit("bye")

try:
    f = open(returnsFILE,'r')
except IOError:
    print ("Cannot open file %s\n" % returnsFILE)
    sys.exit("bye")

endtime = 3600 #3hrs

lines = f.readlines()
allstocks_names=[]
allstocks = []
for j in xrange(len(lines)): #converts data read from file, into stock names and returns
    allstocks_names.append(lines[j].strip().split(',')[0])
    allstocks.append([float(i) if i else 0 for i in lines[j].strip().split(',')[1:]]) #converts comma separated string values into floats. ignores name of index

picked10=[]
for i in xrange(len(picked10)):
    picked10.append(allstocks[allstocks_names.index(picked10[i])])
    for i in xrange(1000000):#number of times to perform iteration
        rsq=0
        randompicks = random.sample(range(0,len(lines)-1),10) #method for choosing stocks based on random seleciton
        #randompicks = 0
        select10=[]
        select10_names = []
        for rnd in xrange(0,len(randompicks)):  #populate list with 10 randomly chosen stocks
        #for rnd in xrange(1,4):
            select10.append(allstocks[randompicks[rnd]])
            select10_names.append(allstocks_names[randompicks[rnd]])
        for k in xrange(0,len(allstocks)):
            rsq+= reg0_m(allstocks[k],select10).rsquared
	if rsq>max_rsq:
	    max_rsq=rsq		
            max_rsq_names = select10_names + [max_rsq]
	if time.time()-stime>endtime:#limit the time of execution
	    break
 
#fout.write(','.join([str(i) for i in max_rsq_names])+'\n')
f.close()

